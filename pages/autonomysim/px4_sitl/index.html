<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/nervosys/AutonomySim/pages/autonomysim/px4_sitl/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Setting up PX4 Software-in-Loop - AutonomySim</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Setting up PX4 Software-in-Loop";
        var mkdocs_page_input_path = "pages\\autonomysim\\px4_sitl.md";
        var mkdocs_page_url = "/nervosys/AutonomySim/pages/autonomysim/px4_sitl/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> AutonomySim
        </a>
        <div class="version">
          master
        </div><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Home</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../README.md">Home</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../../CHANGELOG.md">Changelog</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Building AutonomySim</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../use_precompiled.md">Download Binaries</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../build_windows.md">Build on Windows</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../build_linux.md">Build on Linux</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../build_macos.md">Build on macOS</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../docker_ubuntu.md">Docker on Linux</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../azure.md">AutonomySim on Azure</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../unreal_custenv.md">Custom Unreal Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../Unity.md">AutonomySim with Unity</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../custom_unity_environments.md">Custom Unity Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../unity_api_support.md">Unity APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../build_faq.md">FAQ</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Using AutonomySim</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../apis.md">Core APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../image_apis.md">Image APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../apis_cpp.md">C++ APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../api_docs/html/index.html">API Reference Docs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../dev_workflow.md">Development Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../settings.md">Settings</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../camera_views.md">Camera Views</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../using_car.md">Car Mode</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../remote_control.md">Remote Control</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../xbox_controller.md">XBox Controller</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../steering_wheel_installation.md">Steering Wheel</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../multi_vehicle.md">Multiple Vehicles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Sensors</a>
    <ul>
                <li class="toctree-l2"><a class="" href="../../../sensors.md">Sensors</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../lidar.md">LIDAR</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../distance_sensor.md">Distance Sensor</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../InfraredCamera.md">Infrared Camera</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../AutonomySim_ros_pkgs.md">ROS: AutonomySim ROS Wrapper</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../AutonomySim_tutorial_pkgs.md">ROS: AutonomySim Tutorial Packages</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../gazebo_drone.md">Import Gazebo models</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../retexturing.md">Domain Randomization</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../meshes.md">Mesh Vertex Buffers</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../playback.md">Playing Logs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../voxel_grid.md">Voxel Grid Generator</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../event_sim.md">Event camera</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Design</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../design.md">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../code_structure.md">Code Structure</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../adding_new_apis.md">Adding new APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../modify_recording_data.md">Modifying Recording Data</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../coding_guidelines.md">Coding Guidelines</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../robot_controller.md">Flight Controller</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../simple_flight.md">Simple Flight</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../hello_drone.md">Hello Drone</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">External Flight Controllers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">MavLink and PX4</a>
    <ul>
                <li class="toctree-l2"><a class="" href="../../../px4_setup.md">PX4 Setup for AutonomySim</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../px4_sitl.md">PX4 in SITL</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../px4_sitl_wsl2.md">PX4 SITL with WSL 2</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../px4_lockstep.md">PX4 Lockstep</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../px4_multi_vehicle.md">PX4 Multi-vehicle in SITL</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://youtu.be/1oY8Qu5maQQ">AutonomySim with Pixhawk</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://youtu.be/HNWdYrtw3f0">PX4 Setup with AutonomySim</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://www.youtube.com/watch?v=d_FyjKDWQfc&feature=youtu.be">Debugging Attitude Estimation</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://github.com/nervosys/AutonomySim/wiki/Intercepting-MavLink-messages">Intercepting MavLink Messages</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://github.com/nervosys/AutonomySim/wiki/Rapid-Descent-on-PX4-drones">Rapid Descent on PX4 Drones</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../px4_build.md">Building PX4</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../px4_logging.md">PX4/MavLink Logging</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../log_viewer.md">MavLink LogViewer</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../mavlinkcom.md">MavLinkCom</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../mavlinkcom_mocap.md">MavLink MoCap</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">ArduPilot</a>
    <ul>
                <li class="toctree-l2"><a class="" href="https://ardupilot.org/dev/docs/building-the-code.html">ArduPilot SITL Setup</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://ardupilot.org/dev/docs/sitl-with-AirSim.html">AutonomySim & ArduPilot</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Upgrading</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../unreal_upgrade.md">Upgrading Unreal</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../upgrade_apis.md">Upgrading APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../upgrade_settings.md">Upgrading Settings</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributed Tutorials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../reinforcement_learning.md">Reinforcement Learning</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://www.youtube.com/watch?v=y09VbdQWvQY">Using Environments from Marketplace</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/simondlevy/AirSimTensorFlow">Simple Collision Avoidance</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://aka.ms/AutonomousDrivingCookbook">Autonomous Driving on Azure</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/nervosys/AutonomySim/wiki/hexacopter">Building Hexacopter</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/nervosys/AutonomySim/wiki/moveOnPath-demo">Moving on Path Demo</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../point_clouds.md">Building Point Clouds</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../drone_survey.md">Surveying Using Drone</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../orbit.md">Orbit Trajectory</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://youtu.be/Bp86WiLUC80">Importing a custom multirotor mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../object_detection.md">Object Detection</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://youtu.be/ZonkdMcwXH4">AutonomySim with MAVROS and PX4</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Misc</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../custom_drone.md">AutonomySim on Real Drones</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../cmake_linux.md">Installing cmake on Linux</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../hard_drive.md">Tips for Busy HDD</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../pfm.md">pfm format</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../unreal_proj.md">Setting up Unreal Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../unreal_blocks.md">Blocks Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../who_is_using.md">Who is Using AutonomySim</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../working_with_plugin_contents.md">Working with UE Plugin Contents</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/nervosys/AutonomySim/wiki/technion">Formula Student Technion Self-drive</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Support</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../../../faq.md">FAQ</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../SUPPORT.md">Support</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../create_issue.md">Create Issue</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../CONTRIBUTING.md">Contribute</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">AutonomySim</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Setting up PX4 Software-in-Loop</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/nervosys/AutonomySim/edit/master/docs/pages/autonomysim/px4_sitl.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="setting-up-px4-software-in-loop">Setting up PX4 Software-in-Loop<a class="headerlink" href="#setting-up-px4-software-in-loop" title="Permanent link">#</a></h1>
<p>The <a href="http://dev.px4.io">PX4</a> software provides a "software-in-loop" simulation (SITL) version of their stack that runs in Linux. If you are on Windows then you can use the <a href="https://dev.px4.io/master/en/setup/dev_env_windows_cygwin.html">Cygwin Toolchain</a> or you can use the <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">Windows subsystem for Linux</a> and follow the PX4 Linux toolchain setup.</p>
<p>If you are using WSL2 please read these <a href="../px4_sitl_wsl2/">additional instructions</a>.</p>
<p><strong>Note</strong> that every time you stop the unreal app you have to restart the <code>px4</code> app.</p>
<ol>
<li>
<p>From your bash terminal follow <a href="https://docs.px4.io/master/en/dev_setup/dev_env_linux.html">these steps for Linux</a> and follow <strong>all</strong> the instructions under <code>NuttX based hardware</code> to install prerequisites. We've also included our own copy of the <a href="../px4_build/">PX4 build instructions</a> which is a bit more concise about what we need exactly.</p>
</li>
<li>
<p>Get the PX4 source code and build the posix SITL version of PX4:
    <div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>PX4
<span class="nb">cd</span><span class="w"> </span>PX4
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/PX4/PX4-Autopilot.git<span class="w"> </span>--recursive
bash<span class="w"> </span>./PX4-Autopilot/Tools/setup/ubuntu.sh<span class="w"> </span>--no-nuttx<span class="w"> </span>--no-sim-tools
<span class="nb">cd</span><span class="w"> </span>PX4-Autopilot
</code></pre></div>
    And find the latest stable release from <a href="https://github.com/PX4/PX4-Autopilot/releases">https://github.com/PX4/PX4-Autopilot/releases</a> and checkout the source code matching that release, for example:
    <div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>v1.11.3
</code></pre></div></p>
</li>
<li>
<p>Use following command to build and start PX4 firmware in SITL mode:
    <div class="highlight"><pre><span></span><code>make<span class="w"> </span>px4_sitl_default<span class="w"> </span>none_iris
</code></pre></div>
   If you are using older version v1.8.* use this command instead: <code>make posix_sitl_ekf2 none_iris</code>.</p>
</li>
<li>
<p>You should see a message saying the SITL PX4 app is waiting for the simulator (AutonomySim) to connect. You will also see information about which ports are configured for mavlink connection to the PX4 app. The default ports have changed recently, so check them closely to make sure AutonomySim settings are correct.
    <div class="highlight"><pre><span></span><code>INFO<span class="w">  </span><span class="o">[</span>simulator<span class="o">]</span><span class="w"> </span>Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>simulator<span class="w"> </span>to<span class="w"> </span>connect<span class="w"> </span>on<span class="w"> </span>TCP<span class="w"> </span>port<span class="w"> </span><span class="m">4560</span>
INFO<span class="w">  </span><span class="o">[</span>init<span class="o">]</span><span class="w"> </span>Mixer:<span class="w"> </span>etc/mixers/quad_w.main.mix<span class="w"> </span>on<span class="w"> </span>/dev/pwm_output0
INFO<span class="w">  </span><span class="o">[</span>mavlink<span class="o">]</span><span class="w"> </span>mode:<span class="w"> </span>Normal,<span class="w"> </span>data<span class="w"> </span>rate:<span class="w"> </span><span class="m">4000000</span><span class="w"> </span>B/s<span class="w"> </span>on<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">14570</span><span class="w"> </span>remote<span class="w"> </span>port<span class="w"> </span><span class="m">14550</span>
INFO<span class="w">  </span><span class="o">[</span>mavlink<span class="o">]</span><span class="w"> </span>mode:<span class="w"> </span>Onboard,<span class="w"> </span>data<span class="w"> </span>rate:<span class="w"> </span><span class="m">4000000</span><span class="w"> </span>B/s<span class="w"> </span>on<span class="w"> </span>udp<span class="w"> </span>port<span class="w"> </span><span class="m">14580</span><span class="w"> </span>remote<span class="w"> </span>port<span class="w"> </span><span class="m">14540</span>
</code></pre></div></p>
<p>Note: this is also an interactive PX4 console, type <code>help</code> to see the list of commands you can enter here.  They are mostly low level PX4 commands, but some of them can be useful for debugging.</p>
</li>
<li>
<p>Now edit <a href="../settings/">AutonomySim settings</a> file to make sure you have matching UDP and TCP port settings:
    <div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;SettingsVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;SimMode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Multirotor&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ClockType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SteppableClock&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Vehicles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;PX4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;VehicleType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PX4Multirotor&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;UseSerial&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;LockStep&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;UseTcp&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;TcpPort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4560</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;ControlPortLocal&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">14540</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;ControlPortRemote&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">14580</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Sensors&quot;</span><span class="p">:{</span>
<span class="w">                </span><span class="nt">&quot;Barometer&quot;</span><span class="p">:{</span>
<span class="w">                    </span><span class="nt">&quot;SensorType&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;Enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;PressureFactorSigma&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0001825</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;Parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;NAV_RCL_ACT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;NAV_DLL_ACT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;COM_OBL_ACT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;LPE_LAT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">47.641468</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;LPE_LON&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">-122.140165</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
    Notice the PX4 <code>[simulator]</code> is using TCP, which is why we need to add: <code>"UseTcp": true,</code>. Notice we are also enabling <code>LockStep</code>, see <a href="../px4_lockstep/">PX4 LockStep</a> for more information. The <code>Barometer</code> setting keeps PX4 happy because the default AutonomySim barometer has a bit too much noise generation.  This setting clamps that down a bit which allows PX4 to achieve GPS lock more quickly.</p>
</li>
<li>
<p>Open incoming TCP port 4560 and incoming UDP port 14540 using your firewall configuration.</p>
</li>
<li>
<p>Now run your Unreal AutonomySim environment and it should connect to SITL PX4 via TCP. You should see a bunch of messages from the SITL PX4 window. Specifically, the following messages tell you that AutonomySim is connected properly and GPS fusion is stable:
    <div class="highlight"><pre><span></span><code>INFO<span class="w">  </span><span class="o">[</span>simulator<span class="o">]</span><span class="w"> </span>Simulator<span class="w"> </span>connected<span class="w"> </span>on<span class="w"> </span>UDP<span class="w"> </span>port<span class="w"> </span><span class="m">14560</span>
INFO<span class="w">  </span><span class="o">[</span>mavlink<span class="o">]</span><span class="w"> </span>partner<span class="w"> </span>IP:<span class="w"> </span><span class="m">127</span>.0.0.1
INFO<span class="w">  </span><span class="o">[</span>ecl/EKF<span class="o">]</span><span class="w"> </span>EKF<span class="w"> </span>GPS<span class="w"> </span>checks<span class="w"> </span>passed<span class="w"> </span><span class="o">(</span>WGS-84<span class="w"> </span>origin<span class="w"> </span><span class="nb">set</span><span class="o">)</span>
INFO<span class="w">  </span><span class="o">[</span>ecl/EKF<span class="o">]</span><span class="w"> </span>EKF<span class="w"> </span>commencing<span class="w"> </span>GPS<span class="w"> </span>fusion
</code></pre></div></p>
<p>If you do not see these messages then check your port settings.</p>
</li>
<li>
<p>You should also be able to use QGroundControl with SITL mode. Make sure there is no Pixhawk hardware plugged in, otherwise QGroundControl will choose to use that instead.  Note that as we don't have a physical board, an RC cannot be connected directly to it. So the alternatives are either use XBox 360 Controller or connect your RC using USB (for example, in case of FrSky Taranis X9D Plus) or using trainer USB cable to your PC. This makes your RC look like a joystick. You will need to do extra set up in QGroundControl to use virtual joystick for RC control. You do not need to do this unless you plan to fly a drone manually in AutonomySim. Autonomous flight using the Python API does not require RC, see <code>No Remote Control</code> below.</p>
</li>
</ol>
<h2 id="setting-gps-origin">Setting GPS origin<a class="headerlink" href="#setting-gps-origin" title="Permanent link">#</a></h2>
<p>Notice the above settings are provided in the <code>params</code> section of the <code>settings.json</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">&quot;LPE_LAT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">47.641468</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;LPE_LON&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">-122.140165</span><span class="p">,</span>
</code></pre></div>
<p>PX4 SITL mode needs to be configured to get the home location correct. The home location needs to be set to the same coordinates defined in  <a href="../settings/#origingeopoint">OriginGeopoint</a>.</p>
<p>You can also run the following in the SITL PX4 console window to check that these values are set correctly.</p>
<div class="highlight"><pre><span></span><code>param<span class="w"> </span>show<span class="w"> </span>LPE_LAT
param<span class="w"> </span>show<span class="w"> </span>LPE_LON
</code></pre></div>
<h2 id="smooth-offboard-transitions">Smooth Offboard Transitions<a class="headerlink" href="#smooth-offboard-transitions" title="Permanent link">#</a></h2>
<p>Notice the above setting is provided in the <code>params</code> section of the <code>settings.json</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">&quot;COM_OBL_ACT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>This tells the drone automatically hover after each offboard control command finishes (the default setting is to land).  Hovering is a smoother transition between multiple offboard commands. You can check this setting by running the following PX4 console command:</p>
<div class="highlight"><pre><span></span><code>param<span class="w"> </span>show<span class="w"> </span>COM_OBL_ACT
</code></pre></div>
<h2 id="check-the-home-position">Check the Home Position<a class="headerlink" href="#check-the-home-position" title="Permanent link">#</a></h2>
<p>If you are using DroneShell to execute commands (arm, takeoff, etc) then you should wait until the Home position is set. You will see the PX4 SITL console output this message:</p>
<div class="highlight"><pre><span></span><code>INFO<span class="w">  </span><span class="o">[</span>commander<span class="o">]</span><span class="w"> </span>home:<span class="w"> </span><span class="m">47</span>.6414680,<span class="w"> </span>-122.1401672,<span class="w"> </span><span class="m">119</span>.99
INFO<span class="w">  </span><span class="o">[</span>tone_alarm<span class="o">]</span><span class="w"> </span>home_set
</code></pre></div>
<p>Now DroneShell 'pos' command should report this position and the commands should be accepted by PX4. If you attempt to takeoff without a home position you will see the message:</p>
<div class="highlight"><pre><span></span><code>WARN<span class="w">  </span><span class="o">[</span>commander<span class="o">]</span><span class="w"> </span>Takeoff<span class="w"> </span>denied,<span class="w"> </span>disarm<span class="w"> </span>and<span class="w"> </span>re-try
</code></pre></div>
<p>After home position is set check the local position reported by 'pos' command :</p>
<div class="highlight"><pre><span></span><code>Local<span class="w"> </span>position:<span class="w"> </span><span class="nv">x</span><span class="o">=</span>-0.0326988,<span class="w"> </span><span class="nv">y</span><span class="o">=</span><span class="m">0</span>.00656854,<span class="w"> </span><span class="nv">z</span><span class="o">=</span><span class="m">5</span>.48506
</code></pre></div>
<p>If the z coordinate is large like this then takeoff might not work as expected. Resetting the SITL and simulation should fix that problem.</p>
<h2 id="wsl-2">WSL 2<a class="headerlink" href="#wsl-2" title="Permanent link">#</a></h2>
<p>Windows Subsystem for Linux version 2 operates in a Virtual Machine. This requires additional setup - see <a href="../px4_sitl_wsl2/">additional instructions</a>.</p>
<h2 id="no-remote-control">No Remote Control<a class="headerlink" href="#no-remote-control" title="Permanent link">#</a></h2>
<p>Notice the above setting is provided in the <code>params</code> section of the <code>settings.json</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">&quot;NAV_RCL_ACT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;NAV_DLL_ACT&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</code></pre></div>
<p>This is required if you plan to fly the SITL mode PX4 with no remote control, just using python scripts, for example.  These parameters stop the PX4 from triggering "failsafe mode on" every time a move command is finished.  You can use the following PX4 command to check these values are set correctly:</p>
<div class="highlight"><pre><span></span><code>param<span class="w"> </span>show<span class="w"> </span>NAV_RCL_ACT
param<span class="w"> </span>show<span class="w"> </span>NAV_DLL_ACT
</code></pre></div>
<p>NOTE: Do <code>NOT</code> do this on a real drone as it is too dangerous to fly without these failsafe measures.</p>
<h2 id="manually-set-parameters">Manually set parameters<a class="headerlink" href="#manually-set-parameters" title="Permanent link">#</a></h2>
<p>You can also run the following in the PX4 console to set all these parameters manually:</p>
<div class="highlight"><pre><span></span><code>param<span class="w"> </span><span class="nb">set</span><span class="w"> </span>NAV_RCL_ACT<span class="w"> </span><span class="m">0</span>
param<span class="w"> </span><span class="nb">set</span><span class="w"> </span>NAV_DLL_ACT<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<h2 id="setting-up-multi-vehicle-simulation">Setting up multi-vehicle simulation<a class="headerlink" href="#setting-up-multi-vehicle-simulation" title="Permanent link">#</a></h2>
<p>You can simulate multiple drones in SITL mode using AutonomySim. However, this requires setting up multiple instances of the PX4 firmware simulator to be able to listen for each vehicle's connection on a separate TCP port (4560, 4561, etc). Please see <a href="../px4_multi_vehicle/">this dedicated page</a> for instructions on setting up multiple instances of PX4 in SITL mode.</p>
<h2 id="using-virtualbox-ubuntu">Using VirtualBox Ubuntu<a class="headerlink" href="#using-virtualbox-ubuntu" title="Permanent link">#</a></h2>
<p>If you want to run the above posix_sitl in a <code>VirtualBox Ubuntu</code> machine then it will have a different ip address from localhost. So in this case you need to edit the <a href="../settings/">settings file</a> and change the UdpIp and SitlIp to the ip address of your virtual machine set the LocalIpAddress to the address of your host machine running the Unreal engine.</p>
<h2 id="remote-controller">Remote Controller<a class="headerlink" href="#remote-controller" title="Permanent link">#</a></h2>
<p>There are several options for flying the simulated drone using a remote control or joystick like xbox gamepad. See <a href="../remote_control/#rc-setup-for-px4">remote controllers</a></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright &copy; 2024 Nervosys, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/nervosys/AutonomySim" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
